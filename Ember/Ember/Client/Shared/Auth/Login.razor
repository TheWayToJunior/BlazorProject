@inject HttpClient http
@inject NavigationManager navigationManager

@inject IModalService Modal
@inject ILoginService  loginService

@if (ShowErrors)
{
    <div class="alert alert-danger" role="alert">
        <p>@Error</p>
    </div>
}

<EditForm Model="userInfo" OnValidSubmit="LoginUser">
    <DataAnnotationsValidator />

    <div class="form-group">
        <label for="exampleInputEmail1">Email address</label>
        <input type="email" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp" placeholder="Enter email"
               @bind="@userInfo.Email">
        <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>
        <ValidationMessage For="@(() => userInfo.Email)" />
    </div>

    <div class="form-group">
        <label for="exampleInputPassword1">Password</label>
        <input type="password" class="form-control" id="exampleInputPassword1" placeholder="Password" @bind="@userInfo.Password">
        <ValidationMessage For="@(() => userInfo.Password)" />
    </div>
    <button type="submit" class="btn btn-primary">Log in</button>
</EditForm>

@code {
    string Error = "";
    bool ShowErrors = false;

    private UserInfo userInfo = new UserInfo();

    async Task LoginUser()
    {
        var httpContent = new StringContent(JsonSerializer.Serialize(userInfo), Encoding.UTF8, "application/json");

        var httpResponse = await http.PostAsync("api/account/login", httpContent);

        if (httpResponse.IsSuccessStatusCode)
        {
            var responsString = await httpResponse.Content.ReadAsStringAsync();

            var userToken = JsonSerializer.Deserialize<UserToken>(responsString,
                new JsonSerializerOptions() { PropertyNameCaseInsensitive = true });

            await loginService.Login(userToken.Token);

            Modal.Close();

            navigationManager.NavigateTo("/account");
        }
        else
        {
            var responsString = await httpResponse.Content.ReadAsStringAsync();

            Error = responsString;

            ShowErrors = true;
        }
    }
}